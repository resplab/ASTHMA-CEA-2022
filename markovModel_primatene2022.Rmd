---
title: "Primatine OTC CEA"
author: "Joseph & Kate"
date: '2022-06-14'
output: html_document
---
######################################################################################################
####### Markov Model for CEA of Primatene OTC compared to Symbicort PRN and HCP management #### 2022 #
######################################################################################################

Objective: Cost-effectiveness of over the counter epinephrine vs. budesonide-formoterol in individuals with asthma not managed by a healthcare provider 
Study Population: Uninsured adults with asthma in the US using inhaler 2x weekly 
Setting and Location: US 
Study Perspective: US Societal 
Comparators: OTC Inhaled bud-form vs Inhaled epinephrine vs no OTC option
Model cycle: 1 week 
Time horizon: lifetime
Discount rate: 3% for both costs and QALYs 
Currency: 2021 USD 
Baseline age: 23 years old

Outcomes:  
- Longevity effects: Asthma-related mortality following sever exacerbation, background mortality from US life tables 
- Health-related quality-of-life effects: Utility of non-exacerbation, disutility of severe exacerbation 
Costs: 
- Medical costs: background direct medical costs, severe exacerbation medical costs
- Treatment costs: unit cost of Bud-form, Epi OTC (Primatine mist) 
- Time costs: Patient and caregiver time costs 
- Productivty loss: Presenteeism, absenteeism, unpaid work 

Assumptions 
1. No health insurance and inhaler use twice weekly (2x per week) 
2. Severe exacerbations require ED visit or hospitalization 
3. Patients who received ED care or Hospitalization were assumed to have been referred for care by HCP 
4. Patients under HCP management received daily ICS and as need albuterol (SABA) 
5. Risk reductions in severe exacerbations and asthma-related mortality were modeled for patients receiving healthcare provider management and PRN budesonide-formoterol OTC, with risk increases in asthma fatality modeled for patients receiving PRN inhaled epinephrine OTC 
6. Variable adherence to HCP management 

######################################################################################################
#rm(list = ls())  # remove any variables in R's memory

##################################### Model input #########################################
```{r, Model input setup, include=false}
library(here)
library(tidyverse)
mortality <- read_csv("mortality.csv")

### Model input #
  n.t   <- 20 # (52*(100-23))          # time horizon, lifetime from 23yrs, 1 week cycle
  
  v.n   <- c("H0","H1","SCS","ED","HOSP","D")      # No HCP MGT (H0), HCP MGT (H1), Severe Exacerbation (SEV), Death (D)
  n.s   <- length(v.n)                 # the number of health states
  v.n_sub  <-c("SCS", 
               "ED", 
               "Hospitalization")     # sub-states of SevereExac: systemic corticosteroid uses (SCS), Emergency department visit (ED), hospitalization
  n.s_sub  <- length(v.n_sub)         # number of sub-states  
  
  v.M_1 <- c(1,0,0,0,0,0)                 # Initial health state distribution 
  
  d.c   <- d.e <- (0.03/52)           # equal discounting of costs and QALYs by 3% per year
  v.Trt <- c("No OTC", 
             "Primatene", 
             "Symbicort ", 
             "HCP Management" )       # store the strategy names

```

```{r, model input parameters}
# Severe Exacerbation Rates
## Severe Exacerbation proportion (SCS, ED, HOSP)
  prop.H0_SEV <- prop.PRIM_SEV <- c(0.776,0.130,0.094)
  prop.SYM_SEV <- c(0.819,0.102,0.079)
  prop.H1_SEV <- c(0.784,0.152,0.064)
  
  p.H0_SCS <- (1-exp(-0.20/52)) * prop.H0_SEV[1] # weekly probability of severe exacerbation with no OTC or primatene OTC prn
  p.H0_ED <- (1-exp(-0.20/52)) * prop.H0_SEV[2]
  p.H0_Hosp <- (1-exp(-0.20/52)) * prop.H0_SEV[3]
  
  p.SYM_SCS <- (1-exp(-0.11/52)) * prop.SYM_SEV[1]	# annual rate of severe exacerbation with symbicort PRN
  p.SYM_ED <- (1-exp(-0.11/52)) * prop.SYM_SEV[2]
  p.SYM_Hosp <- (1-exp(-0.11/52)) * prop.SYM_SEV[3]
  
  p.H1_SCS <- (1-exp(-0.12/52)) * prop.H1_SEV[1]	# annual rate of severe exacerbation with HCP management (low dose ICS + SABA)
  p.H1_ED <- (1-exp(-0.12/52)) * prop.H1_SEV[2]
  p.H1_Hosp <- (1-exp(-0.12/52)) * prop.H1_SEV[3]
  
## Transition probabilities #

  #H0
    p.H0_H1   <- 0                                         # weekly probability entering HCP from no HCP management (can't go to H1 without sev)
    pAnn.H0_D   <-  rep(c(0.000976, 0.0000815),n.t/2)      # probability of death from no HCP management (turn into vector) - DUMMY VALUES of vector with                                                              same length as n.t, change to mortality$b_mortality
    p.H0_D   <-  1 - (1-pAnn.H0_D)^(1/52)                 
    
  #H1
    pAnn.H1_H0  <- (1-0.79)                             # probability of non-adherence to HCP management
    p.H1_H0  <- 1 - (1-pAnn.H1_H0)^(1/52)               # probability of non-adherence to HCP management
    p.H1_D   <- p.H0_D 
  
  #SEV
    p.SCS_H0 <- 0
    p.ED_H0 <- 0
    p.Hosp_H0 <- 0
  
    #Asthma Fatality (baseline)
        pAnn.SCS_D <- rep(c(0.0005, 0.0010), n.t/2)
        pAnn.ED_D <- rep(c(0.0032, 0.0064), n.t/2)
        pAnn.Hosp_D <- rep(c(0.0020, 0.0040), n.t/2) 
        
        p.SCS_D <- 1 - (1-pAnn.SCS_D)^(1/52)
        p.ED_D <- 1 - (1-pAnn.ED_D)^(1/52)
        p.Hosp_D <- 1 - (1-pAnn.Hosp_D)^(1/52)

    #Asthma Fatality * Spitzer OR for SABA overuse
        pAnn.SCS_D_PRIM <- rep(c(0.0013, 0.0026),n.t/2)
        pAnn.ED_D_PRIM <- rep(c(0.0083, 0.0160), n.t/2)
        pAnn.Hosp_D_PRIM <- rep(c(0.0052, 0.010), n.t/2)
         
        p.SCS_D_PRIM <- 1 - (1-pAnn.SCS_D_PRIM)^(1/52)
        p.ED_D_PRIM <- 1 - (1-pAnn.ED_D_PRIM)^(1/52)
        p.Hosp_D_PRIM <- 1 - (1-pAnn.Hosp_D_PRIM)^(1/52)

    
## Asthma Control Probability (proportion: mean % of weeks with well controlled asthma)l
  p.H0_AC <- p.PRIM_AC <-  0.31
  p.SYM_AC <- 0.34
  p.H1_AC <- 0.44

### Cost and utility inputs ###
## Direct Medical costs
  c.HCP     <- 53               # cost of HCP management
  c.AU      <- 15               # cost of uncontrolled asthma week
  c.SCS     <- 163               # cost of being in SCS 
  c.ED      <- 744               # cost of being in ED
  c.Hosp    <- 12398               # cost of being in HOSP

## Drug acquisition cost (per DAY) * 7 
  c.PRIM     <- 0.1  * 7               # cost of primatene
  c.SYM      <- 1.35 * 7            # cost of symbicort
  c.ICS      <- 5.44 * 7               # cost of ICS
  c.SABA     <- 0.13 * 7             # cost of SABA
  c.ICS_SABA <- (c.ICS + c.SABA)

## Indirect cost 
  c.timeHCP  <- 2 # HCP management time/week*Assuming 240 total minutes of 4 PCP visits per year, 20 min travel time, 40min wait, median wage $1037 in 2022
  c.prodAU   <- 17 # cost of productivity loss due to asthma not controlled days per week*
  
  #Productivity loss due to severe exacerbation ** Assuming do not go to work for 2,4,7 days
  c.prodSCS  <- 296 # productive lose due to severe exacerbation.
  c.prodED <- 593
  c.prodHosp <- 1037
  
## Utility
  du.AU    <- -0.06                # disutility of asthma uncontrolled day
  du.SCS    <- -0.10               # disutility of systemic corticosteroid use
  du.ED   <- -0.15                 # disutility of emergency department
  du.Hosp <- -0.20                 # disutility of hospitalization
  v.du_exac  <- c(du.SCS, du.ED, du.Hosp)
  
  u.H0 <- u.H1  <- 0.87           # utility of non-exacerbation
  u.AU    <- (u.H0 + du.AU)       # utility of asthma uncontrolled day
  u.SCS    <- (u.H0 + du.SCS)     # utility of SCS
  u.ED   <- (u.H0 + du.ED)        # utility of emergency deparment 
  u.Hosp    <- (u.H0 + du.Hosp)   # utility of hospitalization
  v.u_exac  <- c(u.SCS, u.ED, u.Hosp)

  
```


```{r, Markov Model, include=FALSE}
############################### Markov Model  ###########################

# The Markov function for the 'Sick-Sicker' model keeps track of what happens to the cohort during each cycle. 
Markov <- function(v.M_1, n.t, v.n, d.c, d.e, trt=FALSE) {
# Arguments:  
  # v.M_1:   initial allocation of cohort across states
  # n.t:     total number of cycles to run the model
  # v.n:     vector of health state names
  # d.c:     discount rate for costs
  # d.e:     discount rate for effectiveness (QALYs)
  # Trt:     is this the cohort receiving treatment? (default is FALSE)
  
  v.dwc <- 1 / (1 + d.c) ^ (0:n.t)   # calculate the cost discount weight based on the discount rate d.c 
  v.dwe <- 1 / (1 + d.e) ^ (0:n.t)   # calculate the QALY discount weight based on the discount rate d.e
  
  # create the transition trace matrix (m.TR) capturing the proportion of the cohort in each state at each time point
  m.TR <-  matrix(0, nrow = n.t + 1, ncol = n.s, 
                     dimnames = list( paste("cycle", 0:n.t, sep = ""), v.n))
  
  m.TR[1, ]  <- v.M_1  # indicate the initial health state
  
    
  if(trt=="primatene"){
  
  # run the simulation for no primatene
  for (i in 2:(n.t + 1)) { 
    for (j in 1:n.t) {
      
      # create the transition matrix for each model cycle
      m.P <- matrix(c(1-(p.H0_H1+p.H0_SCS+p.H0_ED+p.H0_Hosp+p.H0_D[j]), p.H0_H1, p.H0_SCS, p.H0_ED, p.H0_Hosp, p.H0_D[j], #H0 (no hcp mgt)
                      p.H1_H0, 1 - (p.H1_H0+p.H1_SCS+p.H1_ED+p.H1_Hosp+p.H1_D[j]), p.H1_SCS, p.H1_ED, p.H1_Hosp, p.H1_D[j], #H1 (hcp mgt)
                      0, 1 - (p.SCS_D_PRIM[j]+p.ED_D_PRIM[j]+p.Hosp_D_PRIM[j]+p.H0_D[j]), 0, 0, 0, p.SCS_D_PRIM[j]+p.H0_D[j], #SCS
                      0, 1 - (p.SCS_D_PRIM[j]+p.ED_D_PRIM[j]+p.Hosp_D_PRIM[j]+p.H0_D[j]), 0, 0, 0, p.ED_D_PRIM[j]+p.H0_D[j], #ED
                      0, 1 - (p.SCS_D_PRIM[j]+p.ED_D_PRIM[j]+p.Hosp_D_PRIM[j]+p.H0_D[j]), 0, 0, 0, p.Hosp_D_PRIM[j]+p.H0_D[j], # Hosp
                      0, 0, 0, 0, 0, 1), #D
                    nrow = n.s, ncol = n.s, byrow = T,
                    dimnames = list(v.n, v.n))
      print(m.P) # show transition matrix for each model cycle to make sure p.H0_D is working - can remove after debugging
      
      # calculate the proportion of the cohort in each state at time t
      m.TR[i, ] <- t(m.TR[i - 1, ]) %*% m.P
    }
  }  # close the loop for the individuals 

  # create vectors of utility and costs for each state
  v.c <- c((c.PRIM + (1- p.H0_AC)*c.AU), #H0
           c.ICS_SABA + c.HCP + c.timeHCP + ((1- p.H1_AC)*c.AU), #H1
           c.SCS + c.prodSCS, #SCS
           c.ED + c.prodED, #ED
           c.Hosp + c.prodHosp, #HOSP
           0) #D
  
  v.u <- c(u.H0 + ((1- p.H0_AC)*7*du.AU), #H0
           u.H1 + ((1- p.H1_AC)*7*du.AU), #H1
           u.SCS, #SCS
           u.ED, #ED
           u.Hosp, #HOSP
           0) #D
  
  v.uc <- c((1-p.H0_AC),
            (1-p.H1_AC), 
            0,
            0,
            0,
            0)  
  
  } 
  
  else{
  if(trt=="symbicort"){
    
  # run the simulation for symbicort
  for (i in 2:(n.t + 1)) { 
    for (j in 1:n.t) {
      
      # create the transition matrix for each model cycle
      m.P <- matrix(c(1-(p.H0_H1+p.H0_SCS+p.H0_ED+p.H0_Hosp+p.H0_D[j]), p.H0_H1, p.SYM_SCS, p.SYM_ED, p.SYM_Hosp, p.H0_D[j], #H0 (no hcp mgt)
                      p.H1_H0, 1 - (p.H1_H0+p.H1_SCS+p.H1_ED+p.H1_Hosp+p.H1_D[j]), p.H1_SCS, p.H1_ED, p.H1_Hosp, p.H1_D[j], #H1 (hcp mgt)
                      0, 1 - (p.SCS_D[j]+p.ED_D[j]+p.Hosp_D[j]+p.H0_D[j]), 0, 0, 0, p.SCS_D[j]+p.H0_D[j], #SCS
                      0, 1 - (p.SCS_D[j]+p.ED_D[j]+p.Hosp_D[j]+p.H0_D[j]), 0, 0, 0, p.ED_D[j]+p.H0_D[j], #ED
                      0, 1 - (p.SCS_D[j]+p.ED_D[j]+p.Hosp_D[j]+p.H0_D[j]), 0, 0, 0, p.Hosp_D[j]+p.H0_D[j], # Hosp
                      0, 0, 0, 0, 0, 1), #D
                    nrow = n.s, ncol = n.s, byrow = T,
                    dimnames = list(v.n, v.n))
      print(m.P) # show transition matrix for each model cycle to make sure p.H0_D is working - can remove after debugging
      
      # calculate the proportion of the cohort in each state at time t
      m.TR[i, ] <- t(m.TR[i - 1, ]) %*% m.P
    }
  }  # close the loop for the individuals 

  # create vectors of utility and costs for each state
  v.c <- c((c.SYM + (1- p.SYM_AC)*c.AU), #H0
           c.ICS_SABA + c.HCP + c.timeHCP + ((1- p.H1_AC)*c.AU), #H1
           c.SCS + c.prodSCS, #SCS
           c.ED + c.prodED, #ED
           c.Hosp + c.prodHosp, #HOSP
           0) #D
  
  v.u <- c(u.H0 + ((1- p.SYM_AC)*7*du.AU), #H0
           u.H1 + ((1- p.H1_AC)*7*du.AU), #H1
           u.SCS, #SCS
           u.ED, #ED
           u.Hosp, #HOSP
           0) #D
  
  v.uc <- c((1-p.SYM_AC),
            (1-p.H1_AC), 
            0,
            0,
            0,
            0)  
  }
    
  else{ #no treatment

# run the simulation for no treatment
for (i in 2:(n.t + 1)) { 
  for (j in 1:n.t) {
    
    # create the transition matrix for each model cycle
    m.P <- matrix(c(1-(p.H0_H1+p.H0_SCS+p.H0_ED+p.H0_Hosp+p.H0_D[j]), p.H0_H1, p.H0_SCS, p.H0_ED, p.H0_Hosp, p.H0_D[j], #H0 (no hcp mgt)
                    p.H1_H0, 1 - (p.H1_H0+p.H1_SCS+p.H1_ED+p.H1_Hosp+p.H1_D[j]), p.H1_SCS, p.H1_ED, p.H1_Hosp, p.H1_D[j], #H1 (hcp mgt)
                    0, 1 - (p.SCS_D[j]+p.ED_D[j]+p.Hosp_D[j]+p.H0_D[j]), 0, 0, 0, p.SCS_D[j]+p.H0_D[j], #SCS
                    0, 1 - (p.SCS_D[j]+p.ED_D[j]+p.Hosp_D[j]+p.H0_D[j]), 0, 0, 0, p.ED_D[j]+p.H0_D[j], #ED
                    0, 1 - (p.SCS_D[j]+p.ED_D[j]+p.Hosp_D[j]+p.H0_D[j]), 0, 0, 0, p.Hosp_D[j]+p.H0_D[j], # Hosp
                    0, 0, 0, 0, 0, 1), #D
                  nrow = n.s, ncol = n.s, byrow = T,
                  dimnames = list(v.n, v.n))
    print(m.P) # show transition matrix for each model cycle to make sure p.H0_D is working - can remove after debugging
    
    # calculate the proportion of the cohort in each state at time t
    m.TR[i, ] <- t(m.TR[i - 1, ]) %*% m.P
  }
}  # close the loop for the individuals 


    
  # create vectors of utility and costs for each state
  v.c <- c(((1- p.H0_AC)*c.AU), #H0
           c.ICS_SABA + c.HCP + c.timeHCP + ((1- p.H1_AC)*c.AU), #H1
           c.SCS + c.prodSCS, #SCS
           c.ED + c.prodED, #ED
           c.Hosp + c.prodHosp, #HOSP
           0) #D
  
  v.u <- c(u.H0 + ((1- p.H0_AC)*7*du.AU), #H0
           u.H1 + ((1- p.H1_AC)*7*du.AU), #H1
           u.SCS, #SCS
           u.ED, #ED
           u.Hosp, #HOSP
           0) #D
  
  v.uc <- c((1-p.H0_AC),
            (1-p.H1_AC), 
            0,
            0,
            0,
            0)  
}
 
}

tuc <- m.TR %*% v.uc
tc <-( m.TR %*% v.c) + (tuc * c.AU)  # calculate the costs, vc should be 0 for severe exac state
te <- m.TR %*% v.u + (tuc %*% du.AU)  # calculate the QALYs, vu should be 0 for severe exac state


tc_hat <- t(tc) %*% v.dwc  # total (discounted) cost 
te_hat <- t(te) %*% v.dwe  # total (discounted) QALY 
tuc_hat <- t(tuc)%*% v.dwe # total (discounted) Asthma uncontrolled

results <- list(m.TR = m.TR, tc_hat = tc_hat, te_hat = te_hat) # store the results from the simulation in a list  
return(results)  # return the results
}

```

```{r, running the model}
##################################### Run the simulation ##################################
sim_markov_no_trt <- Markov(v.M_1, n.t, v.n, d.c, d.e) # run for no treatment
sim_markov_PRIM    <- Markov(v.M_1, n.t, v.n, d.c, d.e, trt = "primatene")  # run for treatement
sim_markov_PRIM    <- Markov(v.M_1, n.t, v.n, d.c, d.e, trt = "symbicort")  # run for treatement


################################# Cost-effectiveness analysis #############################

# store the mean costs of each strategy in a new variable C (vector costs)
v.C <- c(sim_markov_no_trt$tc_hat, sim_markov_trt$tc_hat) 
# store the mean QALYs of each strategy in a new variable E (vector effects)
v.E <- c(sim_markov_no_trt$te_hat, sim_markov_trt$te_hat)

delta.C <- v.C[2] - v.C[1]            # calculate incremental costs
delta.E <- v.E[2] - v.E[1]            # calculate incremental QALYs
ICER <- delta.C / delta.E             # calculate the ICER
results <- c(delta.C, delta.E, ICER)  # store the values in a new variable

# Create full incremental cost-effectiveness analysis table
table_markov <- data.frame(
  round(v.C, 0),              # costs per arm
  round(v.E, 3),              # health outcomes per arm
  c("", round(delta.C, 0)),   # incremental costs
  c("", round(delta.E, 3)),   # incremental QALYs
  c("", round(ICER, 0))       # ICER
)
rownames(table_markov) = v.Trt  # name the rows
colnames(table_markov) = c("Costs", "QALYs","Incremental Costs", "QALYs Gained", "ICER") # name the columns
table_markov                    # print the table 
```
